[gcode_macro END_PRINT]
gcode:
    M117 Finishing...
    
    # 1. Retract BEFORE turning off heat
    {% if printer.extruder.temperature >= 170 %}
        M83 ; Relative extrusion mode
        G1 E-10 F1800 ; Retract 10mm
        G92 E0 ; Reset extruder position
    {% else %}
        { action_respond_info("Extruder too cold to retract safely!") }
    {% endif %}

    # 2. Safe Move Logic (only if homed)
    {% if "xyz" in printer.toolhead.homed_axes %}
        # --- COORDINATE MATH ---
        {% set max_z = printer.toolhead.axis_maximum.z|float %}
        {% set current_z = printer.toolhead.position.z|float %}
        {% set max_x = printer.toolhead.axis_maximum.x|float %}
        {% set max_y = printer.toolhead.axis_maximum.y|float %}
        
        # Calculate safe Z lift (Target 5mm)
        {% if current_z < (max_z - 5.0) %}
            {% set z_safe = 5.0 %}
        {% else %}
            {% set z_safe = max_z - current_z %}
        {% endif %}

        # Define Park Coordinates (Stay 5mm inside physical limits just in case)
        {% set park_x = [240.0, max_x - 5.0]|min %}
        {% set park_y = [220.0, max_y - 5.0]|min %}

        # --- EXECUTE MOVES ---
        G91 ; Relative movement
        G1 Z{z_safe} F3000 ; Lift only what there is room for
        G90 ; Absolute positioning
        G1 X{park_x} Y{park_y} F3000 ; Move to safe park position
    {% else %}
        { action_respond_info("Printer not homed, skipping end moves.") }
    {% endif %}

    # 3. Turn off the heaters and fans
    M104 S0 ; Hotend off
    M140 S0 ; Bed off
    M107    ; Fans off
    
    # 4. Disable Steppers (Excluding Z to prevent gantry drop)
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    M117 Print Complete.