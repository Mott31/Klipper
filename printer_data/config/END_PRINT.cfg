[gcode_macro END_PRINT]
gcode:
    M117 Finishing...
    
    # 1. Safe Retraction: Only retract if the hotend is > 170C
    {% if printer.extruder.temperature >= 170 %}
        M83 ; Relative extrusion
        G1 E-5 F1800 ; Retract 5mm
    {% else %}
        { action_respond_info("Extruder too cold to retract!") }
    {% endif %}

    # 2. Safe Move: Only move to park if the printer is actually homed
    {% if "xyz" in printer.toolhead.homed_axes %}
        G91 ; Relative movement
        G1 Z5 F3000 ; Lift 5mm to clear print
        G90 ; Absolute positioning
        G1 X240 Y220 F3000 ; Move to your custom park position (Back Right)
    {% else %}
        { action_respond_info("Printer not homed, skipping park move!") }
    {% endif %}

    # 3. Shutdown Heaters and Fans
    M104 S0 ; Turn off hotend
    M140 S0 ; Turn off bed
    M107    ; Turn off fans
    
    # 4. Disable X, Y, and Extruder (Keeps Z enabled to prevent "dropping")
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    
    M117 Print Finished - Z Locked