[gcode_macro END_PRINT]
gcode:
    M117 Finishing...
    
    # 1. Retract BEFORE turning off heat
    # This prevents the "Extrude below minimum temp" error
    {% if printer.extruder.temperature >= 170 %}
        M83 ; Relative extrusion mode
        G1 E-10 F1800 ; Retract 10mm (Adjust this value as needed)
        G92 E0 ; Reset extruder position
    {% else %}
        { action_respond_info("Extruder too cold to retract safely!") }
    {% endif %}

    # 2. Safe Move (only if homed)
    {% if "xyz" in printer.toolhead.homed_axes %}
        G91 ; Relative movement
        G1 Z5 F3000 ; Lift 5mm
        G90 ; Absolute positioning
        G1 X240 Y220 F3000 ; Park at back right
    {% endif %}

    # 3. NOW turn off the heaters
    M104 S0 ; Hotend off
    M140 S0 ; Bed off
    M107    ; Fans off
    
    # 4. Lock Z (prevents the drop)
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0