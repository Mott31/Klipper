[gcode_macro END_PRINT]
gcode:
    # 1. Check if hotend is hot enough to retract, if not, skip retraction
    {% if printer.extruder.temperature >= 170 %}
        M83 ; Relative extruder mode
        G1 E-10 F1800 ; Retract 10mm
    {% else %}
        { action_respond_info("Extruder too cold to retract!") }
    {% endif %}

    # 2. Check if the printer is homed before trying to park
    {% if "xyz" in printer.toolhead.homed_axes %}
        G91 ; Relative movement
        G1 Z2 F600 ; Quick 2mm hop
        G90 ; Absolute positioning
        G1 Z230 X240 Y220 F3000 ; Move to park position
    {% else %}
        { action_respond_info("Printer not homed, skipping park move!") }
    {% endif %}

    # 3. Always shut down heaters
    M140 S0 ; Bed off
    M104 S0 ; Hotend off
    M107    ; Fans off

    # 4. Disable only X, Y, and Extruder
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    
    M117 Print Finished